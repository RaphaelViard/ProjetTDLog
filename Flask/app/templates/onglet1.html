<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Onglet 1</title>
    <!-- Intégration de Bootstrap via CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <!-- Barre de navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/">MonApp</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="/">Accueil <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/liste_tickets">Liste des tickets</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/onglet1">Onglet 1</a>
                </li> 
                <li class="nav-item">
                    <a class="nav-link" href="/onglet2">Onglet 2</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/onglet3">Onglet 3</a>
                </li>
            </ul>
        </div>
        <ul class="navbar-nav ml-auto">
            {% if current_user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link" href="/deconnexion">Déconnexion</a>
                </li>
               <li class="nav-item">
                    <a class="nav-link" style="color: green;" href="#">
                       Solde: {{ current_user.money }} €
                    </a>
                </li>
                <li class="nav-item">
                    <span class="nav-link" style="color: white;">Username: {{ current_user.username }}</span>
                </li>
            {% else %}
                  <li class="nav-item">
                      <a class="nav-link" href="/connexion">Connexion</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/inscription">Inscription</a>
              </li>
            {% endif %}       
      </ul>
    </nav>
    <!-- Contenu de la page -->
    <div class="container mt-4">
        <!-- Contenu de l'Onglet 1 -->
        <h1 class="display-4">Bienvenue sur l'Onglet 1</h1>
        <p class="lead" id="nomUtilisateurActif">Bonjour, {{ current_user.username }}!</p>

        <!-- Formulaire de recherche de tickets -->
        <div class="mt-4">
            <h2>Rechercher des Tickets</h2>
            <form method="POST" action="/onglet1">
                <div class="form-group">
                    <label for="nomEvenement">Nom de l'événement</label>
                    <input type="text" class="form-control" id="nomEvenement" name="nomEvenement" placeholder="Entrez le nom de l'événement">
                </div>
                <div class="form-group">
                    <label for="dateEvenement">Date de l'événement</label>
                    <input type="date" class="form-control" id="dateEvenement" name="dateEvenement">
                </div>
                <div class="form-group">
                    <label for="lieuEvenement">Lieu de l'événement</label>
                    <input type="text" class="form-control" id="lieuEvenement" name="lieuEvenement" placeholder="Entrez le lieu">
                </div>
                <button type="submit" class="btn btn-primary">Rechercher</button>
            </form>
        </div>

        <!-- Liste de tickets recommandés et en vente -->
        <div id="listeTickets" class="mt-3">
            <h2>Tickets Recommandés</h2>
            <ul id="ticketsListRecommandes">
                {% for ticket in tickets_recommandes %}
                <li>
                    {{ ticket.nom_evenement }} - {{ ticket.date_evenement }} - {{ ticket.lieu_evenement }} - {{ ticket.prix_ticket }} €
                    <button class="btn btn-primary" onclick="acheterTicket(ticket.id)">Acheter</button>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Scripts Bootstrap et JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.9/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // Fonction pour acheter un ticket
        function acheterTicket(ticketId) {
            $.ajax({
                url: "/acheter_ticket",  // URL de la route Flask pour acheter le ticket
                type: "POST",
                data: { ticket_id: ticketId },  // Envoyez l'ID du ticket au serveur
                dataType: "json",
                success: function (data) {
                    // Mettez à jour la liste des tickets recommandés après l'achat
                    chargerTicketsRecommandes();
                },
                error: function () {
                    console.log("Erreur lors de l'achat du ticket.");
                }
            });
        }

        // Fonction pour charger les tickets recommandés via Ajax
        function chargerTicketsRecommandes() {
            $.ajax({
                url: "/tickets_recommandes",  // L'URL de la route Flask pour récupérer les tickets recommandés
                type: "GET",
                dataType: "json",
                success: function (data) {
                    // Lorsque les données sont récupérées avec succès, mettez à jour la liste des tickets recommandés
                    var ticketsListRecommandes = $("#ticketsListRecommandes");
                    ticketsListRecommandes.empty();  // Effacez la liste actuelle des tickets

                    // Parcourez les données JSON et ajoutez chaque ticket à la liste
                    for (var i = 0; i < data.length; i++) {
                        var ticket = data[i];
                        var listItem = $("<li>").text(ticket.nom_evenement + " - " + ticket.date_evenement + " - " + ticket.lieu_evenement + " - " + ticket.prix_ticket + " € ");
                        var acheterButton = $("<button>").addClass("btn btn-primary").text("Acheter").click(function () {
                            acheterTicket(ticket.id); // Appel de la fonction acheterTicket avec l'ID du ticket
                        });
                        listItem.append(acheterButton);
                        ticketsListRecommandes.append(listItem);
                    }
                },
                error: function () {
                    console.log("Erreur lors de la récupération des tickets recommandés.");
                }
            });
        }

        // Chargez les tickets recommandés au chargement de la page
        $(document).ready(function () {
            chargerTicketsRecommandes();
        });
    </script>
</body>
</html>
